import{C as k,x as g,u as w,y as q,_ as E,r as m,m as U,l as x,c as f,o as v,b as y,a as _,t as F,F as R,q as N,B as C,f as S}from"./index-CTcaoqbD.js";import{u as M}from"./post-DgZ19Mv9.js";const P=k("rating",{state:()=>({loading:!1,error:null}),actions:{async submitRating(s,e){var u;this.loading=!0,this.error=null;const i=w(),c=M(),l=q(),t=(u=i.user)==null?void 0:u.id;if(!t)return this.error="Usuario no autenticado.",this.loading=!1,{success:!1,error:this.error};try{const{data:a,error:p}=await g.from("ratings").select("*").eq("user_id",t).eq("post_id",s).single();if(p&&p.code!=="PGRST116")throw p;let d;if(a?(d=await g.from("ratings").update({rating:e,updated_at:new Date().toISOString()}).eq("id",a.id).select(),console.log(`Rating updated for post ${s} by user ${t} to ${e}`)):(d=await g.from("ratings").insert({user_id:t,post_id:s,rating:e}).select(),console.log(`Rating inserted for post ${s} by user ${t} with ${e}`)),d.error)throw d.error;const{data:o,error:n}=await g.from("posts").select("user_id, title").eq("id",s).single();if(n)console.error("Error fetching post author for notification:",n.message);else if(o&&o.user_id!==t){const{data:r,error:h}=await g.from("users").select("alias").eq("id",t).single(),b=(r==null?void 0:r.alias)||"Un usuario",A=o.title||"tu publicación",$=`${b} calificó tu publicación "${A}" con ${e} estrellas.`;await l.addNotification({user_id:o.user_id,sender_id:t,post_id:s,type:"rating",message:$})}return await c.fetchPosts(),{success:!0,data:d.data}}catch(a){return this.error=a.message,console.error("Error submitting rating:",a.message),{success:!1,error:this.error}}finally{this.loading=!1}},async fetchUserRatingForPost(s,e){if(!e)return 0;try{const{data:i,error:c}=await g.from("ratings").select("rating").eq("user_id",e).eq("post_id",s).single();if(c&&c.code!=="PGRST116")throw c;return i?i.rating:0}catch(i){return console.error("Error fetching user rating:",i.message),0}},async fetchAverageRatingForPost(s){try{const{data:e,error:i}=await g.from("ratings").select("rating").eq("post_id",s);if(i)throw i;if(e&&e.length>0){const c=e.reduce((l,t)=>l+t.rating,0);return parseFloat((c/e.length).toFixed(1))}return 0}catch(e){return console.error("Error fetching average rating:",e.message),0}}}}),B={class:"rating-container"},T={key:0,class:"average-rating"},D={class:"average-value"},G={class:"user-rating-stars"},I=["onClick","onMouseover"],L={key:0,class:"rating-login-prompt"},z={__name:"RatingStars",props:{postId:{type:String,required:!0},initialAverageRating:{type:Number,default:0},initialUserRating:{type:Number,default:0}},setup(s){const e=s,i=w(),c=P(),l=m(e.initialAverageRating),t=m(e.initialUserRating),u=m(0),a=m(!1),p=async o=>{if(!a.value)return;const n=t.value===o?0:o,r=t.value;t.value=n;const{success:h}=await c.submitRating(e.postId,n);h||(t.value=r,console.error("Error al calificar: La calificación no se pudo guardar."))};return U(()=>{a.value=!!i.user,l.value=e.initialAverageRating,t.value=e.initialUserRating}),x([()=>i.user,()=>e.initialAverageRating,()=>e.initialUserRating],([o,n,r])=>{a.value=!!o,l.value=n,t.value=r},{immediate:!0}),(o,n)=>(v(),f("div",B,[l.value!==null&&l.value>0?(v(),f("div",T,[_("span",D,F(l.value.toFixed(1)),1),n[1]||(n[1]=_("span",{class:"star-icon material-symbols-fill"},"star",-1))])):y("",!0),_("div",G,[(v(),f(R,null,N(5,r=>_("span",{key:r,onClick:h=>p(r),class:C({"star-icon":!0,filled:r<=(u.value||t.value),interactive:a.value}),onMouseover:h=>a.value&&(u.value=r),onMouseleave:n[0]||(n[0]=h=>a.value&&(u.value=0))},[r<=(u.value||t.value)?(v(),f(R,{key:0},[S("")],64)):(v(),f(R,{key:1},[S("")],64))],42,I)),64)),a.value?y("",!0):(v(),f("span",L," Inicia sesión para calificar "))])]))}},H=E(z,[["__scopeId","data-v-796851e9"]]);export{H as R};
