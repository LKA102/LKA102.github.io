import{_ as R,u as F,r as c,m as V,E as g,c as t,a as e,b as m,t as i,f as u,F as v,q as x,e as A,x as y,o as l,B as P}from"./index-DAPicXM9.js";const E={class:"rate-mandatory-page-container"},D={key:0,class:"loading-state"},S={key:1},q={class:"post-item-to-rate"},N={class:"post-header"},B=["src"],M={class:"post-info"},$={class:"post-author"},L={class:"post-date"},T={class:"post-title"},I={class:"post-detail"},U={class:"post-detail"},j={key:0,class:"post-file-preview-container"},z=["src","alt"],H=["href"],O=["src","alt"],G=["href"],J=["href"],K={class:"generic-file-icon-preview"},Q=["href"],W={key:1,class:"file-download-action"},X=["href"],Y={class:"rating-section"},Z={class:"stars"},ee=["onClick"],ae=["disabled"],se={key:0,class:"error-message"},oe={key:2,class:"no-posts-found"},te={__name:"RateMandatoryPage",setup(le){const r=F(),s=c(null),_=c(!0),d=c(0),f=c(!1),n=c(""),b=o=>["image/jpeg","image/png","image/gif","image/webp"].includes(o),k=o=>o==="application/pdf";async function h(){_.value=!0,n.value="";try{if(!r.user||r.user.role!=="student"){console.error("Acceso denegado: Solo estudiantes pueden acceder a esta página obligatoria."),g.push({name:"Login"});return}const{data:o,error:a}=await y.rpc("get_random_unrated_post",{p_user_id:r.user.id});if(a)throw a;o&&o.length>0?s.value=o[0]:(s.value=null,n.value="No se encontraron publicaciones disponibles para valorar en este momento o ya las has valorado todas.")}catch(o){console.error("Error fetching random post:",o.message),n.value=`Error al cargar la publicación: ${o.message}`,s.value=null}finally{_.value=!1}}function C(o){d.value=o}async function w(){if(d.value===0||!s.value){n.value="Por favor, selecciona una valoración.";return}f.value=!0,n.value="";try{const{error:o}=await y.from("ratings").upsert({post_id:s.value.id,user_id:r.user.id,rating:d.value},{onConflict:"post_id,user_id"});if(o)throw o;console.log("Valoración enviada con éxito. Re-comprobando requerimiento."),await r.checkRatingRequirement(),r.needsRating?(console.log("Aún necesita valorar. Cargando otro post aleatorio."),d.value=0,await h(),n.value="¡Valoración enviada! Por favor, valora otra publicación si es necesario."):(console.log("Requerimiento de rating cumplido. Redirigiendo a Feed."),g.push({name:"Feed"}))}catch(o){console.error("Error submitting rating:",o.message),n.value=`Error al enviar la valoración: ${o.message}`}finally{f.value=!1}}return V(()=>{r.isAuthenticated&&r.isStudent?h():g.push({name:"Home"})}),(o,a)=>(l(),t("div",E,[_.value?(l(),t("div",D,a[1]||(a[1]=[e("p",null,"Cargando publicación para valorar...",-1),e("i",{class:"fas fa-spinner fa-spin fa-2x"},null,-1)]))):s.value?(l(),t("div",S,[a[12]||(a[12]=e("h2",null,"¡Atención, Estudiante!",-1)),a[13]||(a[13]=e("p",null,"Por favor, valora esta publicación para continuar navegando.",-1)),e("div",q,[e("div",N,[e("img",{src:s.value.author_avatar_url||"https://via.placeholder.com/40/CCCCCC/FFFFFF?text=AV",alt:"Avatar del autor",class:"post-avatar"},null,8,B),e("div",M,[e("span",$,i(s.value.author_alias||s.value.author_email||"Usuario Desconocido"),1),e("span",L,i(new Date(s.value.created_at).toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"})),1)])]),e("h4",T,[e("strong",null,i(s.value.title),1)]),e("p",I,[a[2]||(a[2]=e("strong",null,"Curso:",-1)),u(" "+i(s.value.course),1)]),e("p",U,[a[3]||(a[3]=e("strong",null,"Ciclo:",-1)),u(" "+i(s.value.cycle),1)]),s.value.file_url?(l(),t("div",j,[s.value.thumbnail_url?(l(),t(v,{key:0},[e("img",{src:s.value.thumbnail_url,alt:s.value.title,class:"file-preview-thumbnail"},null,8,z),e("a",{href:s.value.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},a[4]||(a[4]=[e("i",{class:"fas fa-eye"},null,-1),u(" Ver Completo ")]),8,H)],64)):b(s.value.file_type)?(l(),t(v,{key:1},[e("img",{src:s.value.file_url,alt:s.value.title,class:"file-preview-image"},null,8,O),e("a",{href:s.value.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},a[5]||(a[5]=[e("i",{class:"fas fa-eye"},null,-1),u(" Ver Completo ")]),8,G)],64)):k(s.value.file_type)?(l(),t(v,{key:2},[a[7]||(a[7]=e("div",{class:"pdf-icon-preview"},[e("i",{class:"fas fa-file-pdf fa-5x"}),e("p",null,"Documento PDF")],-1)),e("a",{href:s.value.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},a[6]||(a[6]=[e("i",{class:"fas fa-eye"},null,-1),u(" Ver Completo ")]),8,J)],64)):(l(),t(v,{key:3},[e("div",K,[a[8]||(a[8]=e("i",{class:"fas fa-file-alt fa-5x"},null,-1)),e("p",null,"Archivo "+i(s.value.file_type?s.value.file_type.toUpperCase():""),1)]),e("a",{href:s.value.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},a[9]||(a[9]=[e("i",{class:"fas fa-download"},null,-1),u(" Descargar Archivo ")]),8,Q)],64))])):m("",!0),s.value.file_url?(l(),t("div",W,[e("a",{href:s.value.file_url,target:"_blank",rel:"noopener noreferrer",class:"download-button"},a[10]||(a[10]=[e("i",{class:"fas fa-download"},null,-1),u(" Descargar Archivo Completo ")]),8,X)])):m("",!0),e("div",Y,[a[11]||(a[11]=e("h3",null,"Tu Valoración:",-1)),e("div",Z,[(l(),t(v,null,x(5,p=>e("i",{key:p,class:P(["fas fa-star",{active:p<=d.value}]),onClick:re=>C(p)},null,10,ee)),64))]),e("button",{onClick:w,disabled:d.value===0||f.value,class:"submit-rating-button"},i(f.value?"Enviando...":"Valorar y Continuar"),9,ae),n.value?(l(),t("p",se,i(n.value),1)):m("",!0)])])])):(l(),t("div",oe,[a[14]||(a[14]=e("p",null,"No hay publicaciones disponibles para valorar en este momento o ya las has valorado todas.",-1)),a[15]||(a[15]=e("p",null,"Por favor, intenta más tarde o contacta a soporte si crees que esto es un error.",-1)),e("button",{onClick:a[0]||(a[0]=p=>A(r).signOut()),class:"sign-out-button"},"Cerrar Sesión")]))]))}},ie=R(te,[["__scopeId","data-v-0474a2ab"]]);export{ie as default};
