import{C as F,x as h,_ as f,u as C,r as v,m as R,n as w,c as n,b as d,a as t,e as a,t as r,F as m,q as k,j as x,o as i}from"./index-DyqqpZWw.js";const E=F("ranking",{state:()=>({currentRanking:[],monthlyHistory:[],loading:!1,error:null}),actions:{async fetchCurrentRanking(){this.loading=!0,this.error=null;try{const{data:o,error:s}=await h.rpc("get_student_ranking");if(s)throw s;this.currentRanking=o,console.log("Ranking actual:",this.currentRanking)}catch(o){this.error=o.message,console.error("Error al cargar el ranking actual:",o.message)}finally{this.loading=!1}},async fetchMonthlyHistory(){this.loading=!0,this.error=null;try{const{data:o,error:s}=await h.from("monthly_rankings_history").select(`
            id,
            month_year,
            top_score,
            users (
              alias,
              avatar_url
            )
          `).order("month_year",{ascending:!1}).limit(12);if(s)throw s;this.monthlyHistory=o,console.log("Historial de rankings mensuales:",this.monthlyHistory)}catch(o){this.error=o.message,console.error("Error al cargar el historial de rankings:",o.message)}finally{this.loading=!1}},async saveMonthlyTopStudent(){this.loading=!0,this.error=null;try{const{data:o,error:s}=await h.rpc("save_monthly_top_student");if(s)throw s;return o===!1?(console.log("Monthly top student update declined by DB function (e.g., no top student)."),this.loading=!1,!1):(console.log("Monthly top student saved/updated successfully:",o),await this.fetchMonthlyHistory(),!0)}catch(o){return this.error=o.message,console.error("Error al guardar/actualizar el estudiante del mes:",o.message),alert(`Error al guardar/actualizar el ranking: ${o.message}`),!1}finally{this.loading=!1}}}}),M={class:"ranking-page"},S={key:0,class:"status-message"},b={key:1,class:"error-message"},A={key:2,class:"current-ranking-section"},H={class:"podium-container"},D={key:0,class:"podium-item second-place"},V=["src"],N={class:"podium-alias"},P={class:"podium-score"},B={key:1,class:"podium-item first-place"},L=["src"],T={class:"podium-alias"},z={class:"podium-score"},I={key:2,class:"podium-item third-place"},U=["src"],j={class:"podium-alias"},q={class:"podium-score"},O={class:"full-ranking-list"},$={class:"rank-number"},G=["src"],J={class:"list-alias"},K={class:"list-details"},Q={class:"list-score"},W={key:3,class:"status-message"},X={class:"history-section"},Y={key:0,class:"status-message"},Z={key:1,class:"status-message"},ss={key:2,class:"history-list"},ts={class:"history-month"},as=["src"],es={class:"history-alias"},os={class:"history-score"},ns={__name:"Ranking",setup(o){const s=E(),p=C();x();const y=v(!1),g=c=>{const e=document.querySelector(".dropdown-container");e&&!e.contains(c.target)&&(y.value=!1)};return R(async()=>{var c;await p.fetchUserProfile((c=p.user)==null?void 0:c.id),await s.fetchCurrentRanking(),await s.fetchMonthlyHistory(),console.log("Iniciando actualizaciÃ³n diaria del Estudiante del Mes..."),await s.saveMonthlyTopStudent(),document.addEventListener("click",g)}),w(()=>{document.removeEventListener("click",g)}),(c,e)=>(i(),n("div",M,[a(s).loading?(i(),n("p",S,"Cargando ranking...")):a(s).error?(i(),n("p",b,"Error: "+r(a(s).error),1)):d("",!0),a(s).currentRanking.length>0?(i(),n("div",A,[e[5]||(e[5]=t("h2",{class:"section-title"},"Ranking Actual",-1)),t("div",H,[a(s).currentRanking[1]?(i(),n("div",D,[t("img",{src:a(s).currentRanking[1].avatar_url||"https://via.placeholder.com/60/CCCCCC/FFFFFF?text=AV",alt:"2Âº Puesto",class:"podium-avatar"},null,8,V),e[0]||(e[0]=t("span",{class:"place-number"},"2",-1)),t("span",N,r(a(s).currentRanking[1].alias||"Desconocido"),1),t("span",P,r(parseFloat(a(s).currentRanking[1].ranking_score).toFixed(2))+" pts",1)])):d("",!0),a(s).currentRanking[0]?(i(),n("div",B,[e[1]||(e[1]=t("div",{class:"crown-icon"},"ðŸ‘‘",-1)),t("img",{src:a(s).currentRanking[0].avatar_url||"https://via.placeholder.com/80/CCCCCC/FFFFFF?text=AV",alt:"1Âº Puesto",class:"podium-avatar"},null,8,L),e[2]||(e[2]=t("span",{class:"place-number"},"1",-1)),e[3]||(e[3]=t("span",{class:"podium-title"},"ESTUDIANTE DEL MES",-1)),t("span",T,r(a(s).currentRanking[0].alias||"Desconocido"),1),t("span",z,r(parseFloat(a(s).currentRanking[0].ranking_score).toFixed(2))+" pts",1)])):d("",!0),a(s).currentRanking[2]?(i(),n("div",I,[t("img",{src:a(s).currentRanking[2].avatar_url||"https://via.placeholder.com/60/CCCCCC/FFFFFF?text=AV",alt:"3Âº Puesto",class:"podium-avatar"},null,8,U),e[4]||(e[4]=t("span",{class:"place-number"},"3",-1)),t("span",j,r(a(s).currentRanking[2].alias||"Desconocido"),1),t("span",q,r(parseFloat(a(s).currentRanking[2].ranking_score).toFixed(2))+" pts",1)])):d("",!0)]),e[6]||(e[6]=t("h3",{class:"section-subtitle"},"Ranking Completo",-1)),t("ul",O,[c.index>=3?(i(!0),n(m,{key:0},k(a(s).currentRanking,(l,u)=>(i(),n("li",{key:l.user_id,class:"ranking-list-item"},[t("span",$,r(u+1)+".",1),t("img",{src:l.avatar_url||"https://via.placeholder.com/30/CCCCCC/FFFFFF?text=AV",alt:"Avatar",class:"list-avatar"},null,8,G),t("span",J,r(l.alias||"Desconocido"),1),t("span",K,r(l.total_posts)+" pubs, "+r(parseFloat(l.average_rating).toFixed(1))+" avg",1),t("span",Q,r(parseFloat(l.ranking_score).toFixed(2))+" pts",1)]))),128)):d("",!0)])])):(i(),n("p",W,"No hay datos para el ranking actual.")),t("div",X,[e[7]||(e[7]=t("h2",{class:"section-title"},"Historial de Estudiantes del Mes",-1)),a(s).loading?(i(),n("p",Y,"Cargando historial...")):a(s).monthlyHistory.length===0?(i(),n("p",Z,"No hay historial disponible.")):(i(),n("ul",ss,[(i(!0),n(m,null,k(a(s).monthlyHistory,l=>{var u,_;return i(),n("li",{key:l.id,class:"history-list-item"},[t("span",ts,r(l.month_year),1),t("img",{src:((u=l.users)==null?void 0:u.avatar_url)||"https://via.placeholder.com/40/CCCCCC/FFFFFF?text=AV",alt:"Avatar",class:"history-avatar"},null,8,as),t("span",es,r(((_=l.users)==null?void 0:_.alias)||"Desconocido"),1),t("span",os,"Puntaje: "+r(parseFloat(l.top_score).toFixed(2)),1)])}),128))]))])]))}},is=f(ns,[["__scopeId","data-v-65a99d47"]]);export{is as default};
