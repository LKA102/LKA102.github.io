import{_ as Z,r as i,u as ee,y as te,z as le,l as se,m as ae,x as _,n as oe,c as a,a as t,b as f,e as v,f as m,t as u,w as re,d as b,v as P,F,q as N,o,p as T}from"./index-BxpawvPV.js";import{u as ie}from"./post-Bt9XOcwt.js";const ne={class:"profile-page"},ue={class:"profile-details"},de={class:"avatar-section"},ce=["src"],fe={class:"profile-info-group"},ve={key:0},pe={class:"edit-profile-section"},me={class:"form-group"},ge={class:"form-group"},_e=["disabled"],be={key:0,class:"error-message"},ye={key:1,class:"success-message"},Ce={class:"my-posts-section"},ke={key:0,class:"status-message"},Ee={key:1,class:"error-message"},he={key:2,class:"status-message"},we={key:3,class:"post-list"},Pe={class:"post-header"},Fe=["src"],Se={class:"post-info"},Ae={class:"post-author"},xe={class:"post-date"},Ve={key:0,class:"post-actions"},De=["onClick"],Ue=["onClick"],$e={class:"post-title"},qe={class:"post-detail"},ze={class:"post-detail"},Ne={key:0,class:"edit-post-inline"},Me={class:"form-group"},Ie={class:"form-group"},Le=["value"],Re={class:"form-group"},Be=["disabled"],Ge={key:0},Te=["value"],je={key:0,class:"hint-message"},He={key:1,class:"post-rating"},Je={class:"rating-value"},Ke={key:0,class:"star-icon"},Oe={key:2,class:"post-file-preview-container"},Qe=["src","alt"],We=["href"],Xe=["src","alt"],Ye=["href"],Ze=["href"],et={key:3,class:"generic-file-icon-preview"},tt={key:3,class:"file-download-action"},lt=["href"],st={key:0,class:"modal-overlay"},at={class:"modal-content"},ot={class:"modal-buttons"},rt={__name:"Profile",setup(it){const U=i(!1),C=i(null),k=i(""),E=i(""),p=i(""),M=i([]),I=i([]),$=i([]),h=i(!1),r=ee(),g=ie(),q=te(),S=i(""),A=i(""),w=i(null),y=i(null),L=i(null);i(!1),i([]),i(null),i(null);const z=le(()=>g.posts&&r.user?g.posts.filter(s=>s.user_id===r.user.id):[]),j=async()=>{h.value=!0;try{const{data:s,error:e}=await _.from("courses_by_cycle").select("cycle_name, course_code, course_name").order("cycle_name",{ascending:!0}).order("course_code",{ascending:!0});if(e)throw e;M.value=s;const d=[...new Set(s.map(c=>c.cycle_name))];I.value=d}catch(s){console.error("Error al cargar ciclos y cursos:",s.message)}finally{h.value=!1}},R=s=>{if(!s){$.value=[];return}h.value=!0,$.value=M.value.filter(e=>e.cycle_name===s),h.value=!1};se(()=>r.user,async s=>{s!=null&&s.alias&&(S.value=s.alias),s!=null&&s.id?(q.setupRealtimeNotifications(),s.role==="admin"&&await fetchAllStudents()):q.unsubscribeRealtimeNotifications()},{immediate:!0}),ae(async()=>{try{const{data:{user:s}}=await _.auth.getUser();s&&await r.fetchUserProfile(s.id),await j(),g.fetchPosts()}catch(s){console.error("Error al obtener usuario actual o perfil en Mount:",s.message)}}),oe(()=>{q.unsubscribeRealtimeNotifications()});const H=async()=>{var s;w.value=null,y.value=null,r.loading=!0;try{let e=!1,d=!1;if(S.value!==((s=r.user)==null?void 0:s.alias)){const{error:c}=await _.from("users").update({alias:S.value}).eq("id",r.user.id);if(c)throw new Error(`Error al actualizar alias: ${c.message}`);e=!0}if(A.value){const{error:c}=await _.auth.updateUser({password:A.value});if(c)throw new Error(`Error al actualizar contraseña: ${c.message}`);d=!0}e||d?(await r.fetchUserProfile(r.user.id),y.value="Perfil actualizado exitosamente.",A.value=""):y.value="No se realizaron cambios en el perfil."}catch(e){w.value=e.message||"Error desconocido al actualizar perfil.",console.error("Error updating profile:",e)}finally{r.loading=!1}},J=()=>{L.value.click()},K=async s=>{const e=s.target.files[0];if(e){w.value=null,y.value=null,r.loading=!0;try{const d=e.name.split(".").pop(),c=`${r.user.id}/${Date.now()}.${d}`,{error:x}=await _.storage.from("avatars").upload(c,e,{cacheControl:"3600",upsert:!0});if(x)throw new Error(`Error al subir avatar: ${x.message}`);const{data:D}=_.storage.from("avatars").getPublicUrl(c),l=D.publicUrl,{error:V}=await _.from("users").update({avatar_url:l}).eq("id",r.user.id);if(V)throw new Error(`Error al actualizar URL del avatar en DB: ${V.message}`);await r.fetchUserProfile(r.user.id),y.value="Avatar actualizado exitosamente."}catch(d){w.value=d.message||"Error desconocido al subir avatar.",console.error("Error uploading avatar:",d)}finally{r.loading=!1}}},O=s=>{if(!s)return!1;const e=s.toLowerCase();return["jpg","jpeg","png","gif","bmp","webp"].includes(e)},Q=s=>s?s.toLowerCase()==="pdf":!1;function W(s){const e=z.value.find(d=>d.id===s);e&&(C.value={...e},k.value=e.title,E.value=e.course,p.value=e.cycle,e.cycle&&R(e.cycle))}function X(){C.value=null}const B=async()=>{if(C.value)try{await g.updatePost(C.value.id,{title:k.value.trim(),course:E.value.trim(),cycle:p.value.trim()}),U.value=!1,C.value=null,alert("¡Publicación actualizada correctamente!")}catch(s){console.error("Error en saveEditedPost:",s),alert(`Error: ${s.message}`)}},Y=async s=>{if(confirm("¿Estás seguro de que quieres eliminar esta publicación? Esta acción no se puede deshacer."))try{const{error:e}=await _.from("posts").delete().eq("id",s);if(e)throw e;alert("Publicación eliminada exitosamente."),g.fetchPosts()}catch(e){alert("Error al eliminar publicación: "+e.message),console.error("Error deleting post:",e)}};return(s,e)=>{var d,c,x,D;return o(),a("div",ne,[t("section",ue,[e[17]||(e[17]=t("h2",null,"Información del Perfil",-1)),t("div",de,[t("img",{src:((d=v(r).user)==null?void 0:d.avatar_url)||"https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AV",alt:"Avatar del usuario",class:"profile-main-avatar"},null,8,ce),t("button",{onClick:J,class:"edit-avatar-button"},e[10]||(e[10]=[t("i",{class:"fas fa-camera"},null,-1)])),t("input",{type:"file",ref_key:"avatarFileInput",ref:L,onChange:K,accept:"image/*",style:{display:"none"}},null,544)]),t("div",fe,[t("p",null,[e[11]||(e[11]=t("strong",null,"Email:",-1)),m(" "+u((c=v(r).user)==null?void 0:c.email),1)]),t("p",null,[e[12]||(e[12]=t("strong",null,"Rol:",-1)),m(" "+u(((x=v(r).user)==null?void 0:x.role)||"Cargando..."),1)]),(D=v(r).user)!=null&&D.student_code?(o(),a("p",ve,[e[13]||(e[13]=t("strong",null,"Código de Alumno:",-1)),m(" "+u(v(r).user.student_code),1)])):f("",!0)]),t("div",pe,[e[16]||(e[16]=t("h3",null,"Editar Perfil",-1)),t("form",{onSubmit:re(H,["prevent"])},[t("div",me,[e[14]||(e[14]=t("label",{for:"edit-alias"},"Alias:",-1)),b(t("input",{type:"text",id:"edit-alias","onUpdate:modelValue":e[0]||(e[0]=l=>S.value=l),class:"profile-input",required:""},null,512),[[P,S.value]])]),t("div",ge,[e[15]||(e[15]=t("label",{for:"edit-password"},"Nueva Contraseña:",-1)),b(t("input",{type:"password",id:"edit-password","onUpdate:modelValue":e[1]||(e[1]=l=>A.value=l),placeholder:"Dejar en blanco para no cambiar",class:"profile-input"},null,512),[[P,A.value]])]),t("button",{type:"submit",disabled:v(r).loading,class:"save-profile-button"},u(v(r).loading?"Guardando...":"Guardar Cambios"),9,_e),w.value?(o(),a("p",be,u(w.value),1)):f("",!0),y.value?(o(),a("p",ye,u(y.value),1)):f("",!0)],32)])]),t("section",Ce,[e[34]||(e[34]=t("h2",null,"Mis Publicaciones",-1)),v(g).loading?(o(),a("p",ke,"Cargando mis publicaciones...")):v(g).error?(o(),a("p",Ee,"Error al cargar mis publicaciones: "+u(v(g).error),1)):z.value.length===0?(o(),a("p",he,"Aún no tienes publicaciones.")):(o(),a("div",we,[(o(!0),a(F,null,N(z.value,l=>{var V,G;return o(),a("div",{key:l.id,class:"post-item"},[t("div",Pe,[t("img",{src:l.avatar_url||"https://via.placeholder.com/40/CCCCCC/FFFFFF?text=AV",alt:"Avatar del autor",class:"post-avatar"},null,8,Fe),t("div",Se,[t("span",Ae,u(l.alias||l.email||"Usuario Desconocido"),1),t("span",xe,u(new Date(l.created_at).toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"})),1)]),((V=v(r).user)==null?void 0:V.id)===l.user_id?(o(),a("div",Ve,[t("button",{onClick:n=>W(l.id),class:"action-button edit-button",title:"Editar Publicación"},e[18]||(e[18]=[t("i",{class:"fas fa-edit"},null,-1)]),8,De),t("button",{onClick:n=>Y(l.id),class:"action-button delete-button",title:"Eliminar Publicación"},e[19]||(e[19]=[t("i",{class:"fas fa-trash"},null,-1)]),8,Ue)])):f("",!0)]),t("h4",$e,[t("strong",null,u(l.title),1)]),t("p",qe,[e[20]||(e[20]=t("strong",null,"Curso:",-1)),m(" "+u(l.course),1)]),t("p",ze,[e[21]||(e[21]=t("strong",null,"Ciclo:",-1)),m(" "+u(l.cycle),1)]),((G=C.value)==null?void 0:G.id)===l.id?(o(),a("div",Ne,[t("div",Me,[e[22]||(e[22]=t("label",null,"Título:",-1)),b(t("input",{"onUpdate:modelValue":e[2]||(e[2]=n=>k.value=n),class:"profile-input"},null,512),[[P,k.value]])]),t("div",Ie,[e[24]||(e[24]=t("label",null,"Ciclo:",-1)),b(t("select",{"onUpdate:modelValue":e[3]||(e[3]=n=>p.value=n),class:"profile-input",onChange:e[4]||(e[4]=n=>R(p.value)),required:""},[e[23]||(e[23]=t("option",{value:"",disabled:""},"Selecciona un ciclo",-1)),(o(!0),a(F,null,N(I.value,n=>(o(),a("option",{key:n,value:n},u(n),9,Le))),128))],544),[[T,p.value]])]),t("div",Re,[e[26]||(e[26]=t("label",null,"Curso:",-1)),b(t("select",{"onUpdate:modelValue":e[5]||(e[5]=n=>E.value=n),class:"profile-input",disabled:!p.value||h.value,required:""},[e[25]||(e[25]=t("option",{value:"",disabled:""},"Selecciona un curso",-1)),h.value?(o(),a("option",Ge,"Cargando cursos...")):f("",!0),(o(!0),a(F,null,N($.value,n=>(o(),a("option",{key:n.course_code,value:n.course_name},u(n.course_code)+" - "+u(n.course_name),9,Te))),128))],8,Be),[[T,E.value]]),p.value?f("",!0):(o(),a("p",je,"Selecciona un ciclo primero para ver los cursos."))]),t("div",{class:"edit-buttons"},[t("button",{onClick:B,class:"save-profile-button"},"Guardar Cambios"),t("button",{onClick:X,class:"delete-student-button"},"Cancelar")])])):f("",!0),l.average_rating!==void 0?(o(),a("div",He,[e[27]||(e[27]=t("strong",null,"Estrellas:",-1)),t("span",Je,u(l.average_rating?l.average_rating.toFixed(1):"Sin calificación"),1),l.average_rating?(o(),a("span",Ke,"⭐")):f("",!0)])):f("",!0),l.file_url?(o(),a("div",Oe,[l.thumbnail_url?(o(),a(F,{key:0},[t("img",{src:l.thumbnail_url,alt:l.title,class:"file-preview-thumbnail"},null,8,Qe),t("a",{href:l.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},e[28]||(e[28]=[t("i",{class:"fas fa-eye"},null,-1),m(" Ver Completo ")]),8,We)],64)):O(l.file_type)?(o(),a(F,{key:1},[t("img",{src:l.file_url,alt:l.title,class:"file-preview-image"},null,8,Xe),t("a",{href:l.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},e[29]||(e[29]=[t("i",{class:"fas fa-eye"},null,-1),m(" Ver Completo ")]),8,Ye)],64)):Q(l.file_type)?(o(),a(F,{key:2},[e[31]||(e[31]=t("div",{class:"pdf-icon-preview"},[t("i",{class:"fas fa-file-pdf fa-5x"}),t("p",null,"Documento PDF")],-1)),t("a",{href:l.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},e[30]||(e[30]=[t("i",{class:"fas fa-eye"},null,-1),m(" Ver Completo ")]),8,Ze)],64)):(o(),a("div",et,[e[32]||(e[32]=t("i",{class:"fas fa-file-alt fa-5x"},null,-1)),t("p",null,"Archivo "+u(l.file_type?l.file_type.toUpperCase():""),1)]))])):f("",!0),l.file_url?(o(),a("div",tt,[t("a",{href:l.file_url,target:"_blank",rel:"noopener noreferrer",class:"download-button"},e[33]||(e[33]=[t("i",{class:"fas fa-download"},null,-1),m(" Descargar Archivo Completo ")]),8,lt)])):f("",!0)])}),128))]))]),U.value?(o(),a("div",st,[t("div",at,[e[35]||(e[35]=t("h3",null,"Editar Publicación",-1)),e[36]||(e[36]=t("label",null,"Título:",-1)),b(t("input",{"onUpdate:modelValue":e[6]||(e[6]=l=>k.value=l),class:"profile-input"},null,512),[[P,k.value]]),e[37]||(e[37]=t("label",null,"Curso:",-1)),b(t("input",{"onUpdate:modelValue":e[7]||(e[7]=l=>E.value=l),class:"profile-input"},null,512),[[P,E.value]]),e[38]||(e[38]=t("label",null,"Ciclo:",-1)),b(t("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>p.value=l),class:"profile-input"},null,512),[[P,p.value]]),t("div",ot,[t("button",{onClick:B,class:"save-profile-button"},"Guardar Cambios"),t("button",{onClick:e[9]||(e[9]=l=>U.value=!1),class:"delete-student-button"},"Cancelar")])])])):f("",!0)])}}},dt=Z(rt,[["__scopeId","data-v-8c332530"]]);export{dt as default};
