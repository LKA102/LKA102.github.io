import{_ as X,u as H,s as oe,r as m,l as re,m as Y,n as Z,c as a,o as t,a as e,b as w,w as ne,d as I,v as W,p as M,F as U,q as z,t as p,f as F,e as u,x as D,y as ie,z as G,g as K,A as ue,j as ce,i as de,h as pe,B as ve}from"./index-DyqqpZWw.js";import{u as ee}from"./post-hgfmLS-k.js";import{f as Q,g as fe}from"./PostUpload.vue_vue_type_style_index_0_scoped_bb851dd0_lang-DSBaiVOZ.js";import{R as me}from"./RatingStars-DXTGHYj7.js";async function ge(N,P=400,n=400,T=.8){console.log("Iniciando procesamiento de imagen para miniatura...");const S=performance.now();return new Promise((C,r)=>{const c=new FileReader;c.onload=_=>{const y=new Image;y.onload=()=>{let i=y.width,g=y.height;i>g?i>P&&(g*=P/i,i=P):g>n&&(i*=n/g,g=n);const b=document.createElement("canvas"),E=b.getContext("2d");b.width=i,b.height=g,E.drawImage(y,0,0,i,g),b.toBlob($=>{if($){const h=performance.now();console.log(`Miniatura de imagen generada en ${(h-S).toFixed(2)} ms`),C({processedBlob:$,processingTime:h-S,originalSize:N.size,processedSize:$.size})}else r(new Error("Fallo al generar el Blob de la miniatura."))},N.type==="image/png"?"image/png":"image/jpeg",T)},y.onerror=i=>{r(new Error("No se pudo cargar la imagen para procesamiento."))},y.src=_.target.result},c.onerror=_=>{r(new Error("No se pudo leer el archivo de imagen."))},c.readAsDataURL(N)})}const he={class:"post-upload-container"},_e={class:"upload-input-wrapper"},ye={key:0,class:"modal-overlay"},be={class:"post-upload-modal"},we={class:"form-group"},Ce={class:"form-group"},ke=["disabled"],Pe=["value"],$e={key:0,class:"hint-message"},Ue={key:1,class:"hint-message"},Se={class:"form-group"},Fe=["disabled"],Te={value:"",disabled:""},De=["value"],Ee={key:0,class:"hint-message"},xe={key:1,class:"hint-message"},ze={key:2,class:"hint-message"},Ie={class:"form-group"},Ne={key:0,class:"file-name"},Re={key:1,class:"processing-message"},Le={key:2,class:"processed-info"},Ve={key:3,class:"processed-info"},Me={key:4,class:"thumbnail-preview"},je=["src"],Be={class:"modal-actions"},Ae=["disabled"],qe={key:0},Oe={key:1},Ge={key:2},Ke={key:0,class:"error-message"},Je={__name:"PostUpload",setup(N){const P=H(),n=ee(),{loading:T,error:S}=oe(n),C=m(!1),r=m({title:"",course:"",cycle:"",thumbnail_url:null}),c=m(null),_=m(!1),y=m(0),i=m(0),g=m(0),b=m(null),E=m([]),$=m([]),h=m(""),d=m([]),l=m(!1),x=async()=>{l.value=!0;try{const{data:f,error:o}=await D.from("courses_by_cycle").select("cycle_name, course_code, course_name").order("cycle_name",{ascending:!0}).order("course_code",{ascending:!0});if(o)throw o;E.value=f;const v=[...new Set(f.map(B=>B.cycle_name))];$.value=v}catch(f){console.error("Error al cargar ciclos y cursos:",f.message)}finally{l.value=!1}},s=()=>{r.value.course="",h.value?d.value=E.value.filter(f=>f.cycle_name===h.value):d.value=[]};re(h,f=>{r.value.cycle=f});const J=async()=>{C.value=!0,$.value.length===0&&await x(),h.value="",r.value.course="",r.value.title="",r.value.thumbnail_url=null,d.value=[],c.value=null,_.value=!1,y.value=0,i.value=0,g.value=0,b.value=null;const f=document.getElementById("post-file");f&&(f.value="")},j=()=>{C.value=!1,r.value.title="",r.value.course="",r.value.cycle="",r.value.thumbnail_url=null,c.value=null;const f=document.getElementById("post-file");f&&(f.value=""),h.value="",d.value=[],_.value=!1,y.value=0,i.value=0,g.value=0,b.value=null},se=async f=>{const o=f.target.files.length>0?f.target.files.item(0):null;if(c.value=null,y.value=0,i.value=0,g.value=0,_.value=!1,b.value=null,r.value.thumbnail_url=null,o){const v=o.name.split(".").pop().toLowerCase(),B=o.type.split("/")[0];if(v==="pdf"){_.value=!0,y.value=o.size;try{const{thumbnailBlob:k,processingTime:A,processedSize:q}=await fe(o);c.value=o;const{data:{user:R}}=await D.auth.getUser();if(!R)throw new Error("No user found. Please log in again.");const L=`${R.id}/${Date.now()}_thumb.jpeg`,{data:te,error:V}=await D.storage.from("thumbnails").upload(L,k,{cacheControl:"3600",upsert:!1,contentType:"image/jpeg"});if(V)throw V;const{data:O}=D.storage.from("thumbnails").getPublicUrl(L);r.value.thumbnail_url=O.publicUrl,i.value=q,g.value=A,b.value=URL.createObjectURL(k)}catch(k){console.error("Error durante el procesamiento/subida de miniatura PDF:",k),alert("Hubo un error al generar o subir la miniatura del PDF. El archivo principal se subirá, pero sin miniatura."),c.value=o,r.value.thumbnail_url=null}finally{_.value=!1}}else if(B==="image"&&["jpg","jpeg","png","gif"].includes(v)){_.value=!0,y.value=o.size;try{const{processedBlob:k,processingTime:A,processedSize:q}=await ge(o);c.value=o;const{data:{user:R}}=await D.auth.getUser();if(!R)throw new Error("No user found. Please log in again.");const L=`${R.id}/${Date.now()}_thumb.${k.type.split("/")[1]}`,{data:te,error:V}=await D.storage.from("thumbnails").upload(L,k,{cacheControl:"3600",upsert:!1,contentType:k.type});if(V)throw V;const{data:O}=D.storage.from("thumbnails").getPublicUrl(L);r.value.thumbnail_url=O.publicUrl,i.value=q,g.value=A,b.value=URL.createObjectURL(k)}catch(k){console.error("Error durante el procesamiento/subida de miniatura de imagen:",k),alert("Hubo un error al optimizar o subir la miniatura de la imagen. El archivo original se subirá, pero sin miniatura."),c.value=o,r.value.thumbnail_url=null}finally{_.value=!1}}else c.value=o,r.value.thumbnail_url=null}},le=async()=>{if(!r.value.title||!r.value.course||!h.value){alert("Por favor, completa todos los campos del formulario (Título, Ciclo y Curso).");return}if(!c.value){alert("Por favor, selecciona un archivo para subir.");return}if(_.value){alert("Por favor, espera a que el archivo termine de procesarse.");return}r.value.cycle=h.value,await n.uploadPost(r.value,c.value),S.value||j()};return Y(()=>{P.user&&!P.userProfile&&P.fetchUserProfile(P.user.id)}),Z(()=>{b.value&&URL.revokeObjectURL(b.value)}),(f,o)=>(t(),a("div",he,[e("div",_e,[e("input",{type:"text",placeholder:"¿Qué apunte publicarás hoy?",class:"upload-placeholder",onFocus:J,readonly:""},null,32)]),C.value?(t(),a("div",ye,[e("div",be,[o[10]||(o[10]=e("h3",null,"Crear Nueva Publicación",-1)),e("form",{onSubmit:ne(le,["prevent"])},[e("div",we,[o[3]||(o[3]=e("label",{for:"post-title"},"Título del Apunte:",-1)),I(e("input",{type:"text",id:"post-title","onUpdate:modelValue":o[0]||(o[0]=v=>r.value.title=v),placeholder:"Ej: Resumen de Álgebra Lineal",required:""},null,512),[[W,r.value.title]])]),e("div",Ce,[o[5]||(o[5]=e("label",{for:"post-cycle"},"Ciclo:",-1)),I(e("select",{id:"post-cycle","onUpdate:modelValue":o[1]||(o[1]=v=>h.value=v),onChange:s,required:"",disabled:l.value},[o[4]||(o[4]=e("option",{value:"",disabled:""},"Selecciona un ciclo",-1)),(t(!0),a(U,null,z($.value,v=>(t(),a("option",{key:v,value:v},p(v),9,Pe))),128))],40,ke),[[M,h.value]]),l.value?(t(),a("p",$e,"Cargando ciclos...")):$.value.length===0?(t(),a("p",Ue,"No se encontraron ciclos.")):w("",!0)]),e("div",Se,[o[6]||(o[6]=e("label",{for:"post-course"},"Curso:",-1)),I(e("select",{id:"post-course","onUpdate:modelValue":o[2]||(o[2]=v=>r.value.course=v),required:"",disabled:!h.value||l.value},[e("option",Te,p(h.value?l.value?"Cargando cursos...":"Selecciona un curso":"Selecciona un ciclo primero"),1),(t(!0),a(U,null,z(d.value,v=>(t(),a("option",{key:v.course_code,value:v.course_name},p(v.course_code)+" - "+p(v.course_name),9,De))),128))],8,Fe),[[M,r.value.course]]),h.value?l.value?(t(),a("p",xe,"Cargando cursos del ciclo...")):d.value.length===0?(t(),a("p",ze,"No se encontraron cursos para este ciclo.")):w("",!0):(t(),a("p",Ee,"Selecciona un ciclo para ver los cursos."))]),e("div",Ie,[o[9]||(o[9]=e("label",{for:"post-file"},"Archivo (PDF, DOCX, PPT, JPG, PNG):",-1)),e("input",{type:"file",id:"post-file",onChange:se,accept:".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.gif",required:""},null,32),c.value?(t(),a("p",Ne,p(c.value.name),1)):w("",!0),_.value?(t(),a("p",Re,o[7]||(o[7]=[e("i",{class:"fas fa-spinner fa-spin"},null,-1),F(" Generando previsualización... ")]))):w("",!0),i.value>0?(t(),a("p",Le," Tamaño original: "+p(u(Q)(y.value))+" -> Miniatura generada: "+p(u(Q)(i.value)),1)):w("",!0),g.value>0?(t(),a("p",Ve," Tiempo de procesamiento: "+p(g.value.toFixed(2))+" ms ",1)):w("",!0),b.value?(t(),a("div",Me,[o[8]||(o[8]=e("h4",null,"Miniatura generada:",-1)),e("img",{src:b.value,alt:"Miniatura del documento"},null,8,je)])):w("",!0)]),e("div",Be,[e("button",{type:"button",onClick:j,class:"cancel-button"},"Cancelar"),e("button",{type:"submit",disabled:u(T)||_.value},[u(T)?(t(),a("span",qe,"Subiendo...")):_.value?(t(),a("span",Oe,"Procesando...")):(t(),a("span",Ge,"Publicar"))],8,Ae)]),u(S)?(t(),a("p",Ke,p(u(S)),1)):w("",!0)],32),e("button",{onClick:j,class:"close-modal-button"},"×")])])):w("",!0)]))}},Qe=X(Je,[["__scopeId","data-v-bb851dd0"]]),Xe={class:"feed-page"},He={class:"filters-container"},Ye={class:"search-bar"},Ze={class:"filter-dropdowns"},We=["value"],es=["value"],ss={key:0,class:"status-message"},ls={key:1,class:"error-message"},as={key:2,class:"status-message"},ts={key:3,class:"post-list"},os={class:"post-header"},rs=["src"],ns={class:"post-info"},is={class:"post-author"},us={class:"post-date"},cs={class:"post-title"},ds={class:"post-detail"},ps={class:"post-detail"},vs={key:0,class:"post-file-preview-container"},fs=["src","alt"],ms=["href"],gs=["src","alt"],hs=["href"],_s=["href"],ys={class:"generic-file-icon-preview"},bs=["href"],ws={key:1,class:"file-download-action"},Cs=["href"],ks={key:4,class:"pagination-bar"},Ps=["onClick","disabled"],$s={class:"page-status"},Us={__name:"Feed",setup(N){function P(d,l){let x;return function(...s){clearTimeout(x),x=setTimeout(()=>d.apply(this,s),l)}}const n=ee(),T=H();ce();const S=ie(),C=m(""),r=m(""),c=m(""),_=m(!1);m(!1);const y=G(()=>Math.ceil(n.total/n.itemsPerPage));G(()=>`${n.posts.length} de ${n.total}`),G(()=>n.posts.length<n.total);const i=P(async()=>{await n.fetchPosts({searchTerm:C.value||null,course:r.value||null,cycle:c.value||null,reset:!0})},300),g=async()=>{C.value="",r.value="",c.value="",await n.fetchPosts({searchTerm:null,course:null,cycle:null,reset:!0})},b=d=>{const l=document.querySelector(".dropdown-container");l&&!l.contains(d.target)&&(_.value=!1)},E=d=>d?["jpg","jpeg","png","gif","bmp","webp"].includes(d.toLowerCase()):!1,$=d=>(d==null?void 0:d.toLowerCase())==="pdf";Y(async()=>{if(T.user)try{await T.fetchUserProfile(T.user.id),await Promise.all([n.fetchUniqueCourses(),n.fetchUniqueCycles()]),await n.fetchPosts({authorRole:"student",reset:!0}),S.setupRealtimeNotifications()}catch(d){console.error("Initialization error:",d)}}),Z(()=>{S.unsubscribeRealtimeNotifications(),document.removeEventListener("click",b)});const h=async d=>{await n.fetchPosts({page:d,searchTerm:C.value,course:r.value,cycle:c.value,reset:!0}),window.scrollTo({top:0,behavior:"smooth"})};return(d,l)=>{const x=de("router-link");return t(),a("div",Xe,[K(Qe),e("div",He,[e("div",Ye,[I(e("input",{type:"text","onUpdate:modelValue":l[0]||(l[0]=s=>C.value=s),placeholder:"Buscar por título, curso o ciclo...",onKeyup:l[1]||(l[1]=ue((...s)=>u(i)&&u(i)(...s),["enter"]))},null,544),[[W,C.value]]),e("button",{onClick:l[2]||(l[2]=(...s)=>u(i)&&u(i)(...s)),class:"search-button"},l[7]||(l[7]=[e("i",{class:"fas fa-search"},null,-1),F(" Buscar ")])),C.value||r.value||c.value?(t(),a("button",{key:0,onClick:g,class:"clear-filters-button"}," Limpiar Filtros ")):w("",!0)]),e("div",Ze,[I(e("select",{"onUpdate:modelValue":l[3]||(l[3]=s=>c.value=s),onChange:l[4]||(l[4]=(...s)=>u(i)&&u(i)(...s)),class:"filter-select"},[l[8]||(l[8]=e("option",{value:""},"Todos los Ciclos",-1)),(t(!0),a(U,null,z(u(n).cycles,s=>(t(),a("option",{key:s,value:s},p(s),9,We))),128))],544),[[M,c.value]]),I(e("select",{"onUpdate:modelValue":l[5]||(l[5]=s=>r.value=s),onChange:l[6]||(l[6]=(...s)=>u(i)&&u(i)(...s)),class:"filter-select"},[l[9]||(l[9]=e("option",{value:""},"Todos los Cursos",-1)),(t(!0),a(U,null,z(u(n).courses,s=>(t(),a("option",{key:s,value:s},p(s),9,es))),128))],544),[[M,r.value]])])]),u(n).loading?(t(),a("p",ss,"Cargando publicaciones...")):u(n).error?(t(),a("p",ls,"Error al cargar publicaciones: "+p(u(n).error),1)):u(n).posts.length===0?(t(),a("p",as,"No hay publicaciones disponibles.")):(t(),a("div",ts,[(t(!0),a(U,null,z(u(n).posts,s=>(t(),a("div",{key:s.id,class:"post-item"},[e("div",os,[K(x,{to:`/users/${s.user_id}`,class:"post-author-link"},{default:pe(()=>[e("img",{src:s.avatar_url||"https://via.placeholder.com/40/CCCCCC/FFFFFF?text=AV",alt:"Avatar del autor",class:"post-avatar"},null,8,rs)]),_:2},1032,["to"]),e("div",ns,[e("span",is,p(s.alias||s.email||"Usuario Desconocido"),1),e("span",us,p(new Date(s.created_at).toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"})),1)])]),e("h4",cs,[e("strong",null,p(s.title),1)]),e("p",ds,[l[10]||(l[10]=e("strong",null,"Curso:",-1)),F(" "+p(s.course),1)]),e("p",ps,[l[11]||(l[11]=e("strong",null,"Ciclo:",-1)),F(" "+p(s.cycle),1)]),s.file_url?(t(),a("div",vs,[s.thumbnail_url?(t(),a(U,{key:0},[e("img",{src:s.thumbnail_url,alt:s.title,class:"file-preview-thumbnail"},null,8,fs),e("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},l[12]||(l[12]=[e("i",{class:"fas fa-eye"},null,-1),F(" Ver Completo ")]),8,ms)],64)):E(s.file_type)?(t(),a(U,{key:1},[e("img",{src:s.file_url,alt:s.title,class:"file-preview-image"},null,8,gs),e("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},l[13]||(l[13]=[e("i",{class:"fas fa-eye"},null,-1),F(" Ver Completo ")]),8,hs)],64)):$(s.file_type)?(t(),a(U,{key:2},[l[15]||(l[15]=e("div",{class:"pdf-icon-preview"},[e("i",{class:"fas fa-file-pdf fa-5x"}),e("p",null,"Documento PDF")],-1)),e("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},l[14]||(l[14]=[e("i",{class:"fas fa-eye"},null,-1),F(" Ver Completo ")]),8,_s)],64)):(t(),a(U,{key:3},[e("div",ys,[l[16]||(l[16]=e("i",{class:"fas fa-file-alt fa-5x"},null,-1)),e("p",null,"Archivo "+p(s.file_type?s.file_type.toUpperCase():""),1)]),e("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",class:"file-link-overlay"},l[17]||(l[17]=[e("i",{class:"fas fa-download"},null,-1),F(" Descargar Archivo ")]),8,bs)],64))])):w("",!0),s.file_url?(t(),a("div",ws,[e("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",class:"download-button"},l[18]||(l[18]=[e("i",{class:"fas fa-download"},null,-1),F(" Descargar Archivo Completo ")]),8,Cs)])):w("",!0),K(me,{"post-id":s.id,"initial-average-rating":s.average_rating,"initial-user-rating":s.user_rating},null,8,["post-id","initial-average-rating","initial-user-rating"])]))),128))])),y.value>1?(t(),a("div",ks,[(t(!0),a(U,null,z(y.value,s=>(t(),a("button",{key:s,class:ve({"active-page":s===u(n).currentPage}),onClick:J=>h(s),disabled:s===u(n).currentPage},p(s),11,Ps))),128))])):w("",!0),e("p",$s," Mostrando "+p(u(n).posts.length)+" de "+p(u(n).total)+" publicaciones ",1)])}}},Es=X(Us,[["__scopeId","data-v-6894e371"]]);export{Es as default};
